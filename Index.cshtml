 
<html>
    <header>
	
	<title>Danger Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- This is all the leaflet stuff for the map API -->
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

    
    </header>
    <body>
        <div id="mapid"></div>
        <script>

            var mymap;
            var myPins = new Array();
            var pinList;
            var lat = 40.416;
            var long = -3.704; //default to madrid

            //TODO ERROR HERE
            if (navigator.geolocation) {
                // geolocation is available
                navigator.geolocation.getCurrentPosition(
                    function(position) {

                    var lat = position.coords.latitude;
                    var long = position.coords.longitude;

                    }
                );
            } 

            //if geolocation not supported or denied, defaults to lat, long of madrid :)
            mymap = L.map('mapid').setView([lat, long], 15); //centered around mardid

            //must note contributions! TODO fix that this is out of frame by filling screen on some laptops :((((	
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);

            var popup = L.popup();


            function storeLocation(latlang, goodBad) {
                

                //make data organized? TODO
                var data = "latlng="+latlang+"&goodOrBad="+goodBad;

                var xhr = new XMLHttpRequest();

                xhr.onreadystatechange = function(){

                    if(xhr.readyState == 4 && xhr.status == 200){
                        console.log(xhr.responseText);
                                    }


                            }


                xhr.open( "POST", "map_data.php", true);
                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr.send(data);


    var LeafIcon = L.Icon.extend({
                                    options: {
                                            iconSize:     [30, 30],
                                            shadowSize:   [50, 64],
                                            iconAnchor:   [15, 15],
                                            popupAnchor:  [-3, -76]
                                    }
                            });


                            var greenIcon = new LeafIcon({iconUrl: 'green_pin.png'});
                            var redIcon = new LeafIcon({iconUrl: 'red_pin.png'});

                //"LatLng(40.14241241, -3.1231238)"
                console.log(latlang);
                latlng =latlang.toString();
                            latlng = latlng.replace("LatLng(","").replace(")", "").replace(" ","");
                            lat_long = latlng.split(",");//supposed to use regex but eh

                                                    lat = parseFloat(lat_long[0]);
                                                    long = parseFloat(lat_long[1]);

                if(goodBad == "good")
                                                    {
                                                            L.marker([lat, long], {icon: greenIcon}).addTo(mymap);
                                                            console.log("hello");
                                                    }
                                                    else{
                                                            L.marker([lat, long], {icon: redIcon}).addTo(mymap);
                                                    }



            }

            function readLocation() {
                
                var ajax = new XMLHttpRequest();

                ajax.onreadystatechange = function(){
                    //alert(this.status);
                                    if(this.readyState == 4 && this.status == 200){
                                            console.log(this.responseText);
                                            var data = JSON.parse(this.responseText);
                        console.log(data);
                        pinList = data;
                                    }

                            };
                        
            

                ajax.open("GET", "retrieve_data.php", true);
                ajax.send();

            }

            function createButton(label, container, latlng) {
                var btn = L.DomUtil.create('button', '', container);
                btn.setAttribute('type', 'button');
                btn.innerHTML = label;
                btn.latlng = latlng;
                return btn;
            }


            function onMapClick(e) {
                
                var container = L.DomUtil.create('div');
                
                goodBtn = createButton("Good", container,e.latlng);
                badBtn = createButton("Bad", container, e.latlng);
                
                //div.innerHTML = ''+startBtn+ '&nbsp;&nbsp;&nbsp;&nbsp;' + destBtn ; 

                popup
                    .setLatLng(e.latlng)
                    .setContent(container)
                    .openOn(mymap);

                L.DomEvent.on(goodBtn, 'click', () => {
                    storeLocation(goodBtn.latlng, "good");
                    mymap.closePopup();
                });

                
                L.DomEvent.on(badBtn, 'click', () => {
                    storeLocation(badBtn.latlng, "bad");
                    mymap.closePopup();
                });
            }

            mymap.on('click', onMapClick);


                    function populateInitialPins()
                    {
                            var LeafIcon = L.Icon.extend({
                                    options: {
                                            iconSize:     [30, 30],
                                            shadowSize:   [50, 64],
                                            iconAnchor:   [15, 15],
                                            popupAnchor:  [-3, -76]
                                    }
                            });


                            var greenIcon = new LeafIcon({iconUrl: 'green_pin.png'});
                            var redIcon = new LeafIcon({iconUrl: 'red_pin.png'});


                var ajax = new XMLHttpRequest();

                            ajax.onreadystatechange = function(){
                                    //alert(this.status);
                                    if(this.readyState == 4 && this.status == 200){

                        var data = JSON.parse(this.responseText);

                        for(var i = 0; i < data.length; i++){

                                            var obj = data[i];
                            console.log(obj);
                                            //"LatLng(40.14241241, -3.1231238)"
                                            obj['latlng'] = obj['latlng'].replace("LatLng(","").replace(")", "").replace(" ","");
                                            lat_long = obj.latlng.split(",");//supposed to use regex but eh
                                            
                            lat = parseFloat(lat_long[0]);
                            long = parseFloat(lat_long[1]);


                                            if(obj.goodOrbad == "good")
                                            {
                                L.marker([lat, long], {icon: greenIcon}).addTo(mymap);
                                console.log("hello");
                                            }
                            else{
                                L.marker([lat, long], {icon: redIcon}).addTo(mymap);						
                            }

                        
                        }

                                    }

                            };



                            ajax.open("GET", "retrieve_data.php", true);
                            ajax.send();




                    }
                    populateInitialPins()


        </script>
    </body>

</html>